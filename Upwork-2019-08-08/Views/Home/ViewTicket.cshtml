@model List<Upwork_2019_08_08.Models.Message>
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>
    Ticket #@ViewBag.ticket.id <span>
    @if (ViewBag.ticket.status != 'c')
    {
        <button type="button"
                class="btn " data-toggle="modal" data-target="#exampleModalCenter">
            +Add Message
        </button>
    }
</span>
</h2>

<h5>
    Status:                 @switch (ViewBag.ticket.status)
    {
        case 'n':
            <span style="color: green">New</span>
            break;
        case 'p':
            <span style="color: goldenrod">In Progress</span>
            break;
        case 'c':
            <span style="color: red">Closed</span>
            break;
    }
</h5>
<button class="dt-button buttons-pdf buttons-html5" onclick="myFunction()" style="background: #1c536b!important; color: white;">Close the ticket</button>

<div class="accordion" id="accordionExample">
    @{ int row = 0;}
    @foreach (var item in Model)
    {
        string collapsename = "collapse" + row.ToString();
        <div class="card">
            <div class="card-header" id="headingOne">
                <h2 class="mb-0">
                    <button class="btn btn-link" id="btnMail" type="button" data-toggle="collapse" data-target="#@collapsename" aria-expanded="true" aria-controls="collapseOne">
                        <p style="text-align: start">Subject: @item.subject</p>     <p style="text-align: start">Date: @item.datetime.ToString("dd MMMM yyyy hh:mm") </p>  <p style="text-align: start">
                            From whom: @if (item.Ticket.clientID == HttpContextAccessor.HttpContext.Session.GetInt32("LogedIn").GetValueOrDefault(0))
                            {<span>you</span> }
                            else
                            { <span>@ViewBag.names[row]</span>}
                        </p>
                    </button>
                </h2>
            </div>

            <div id="@collapsename" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                <div class="card-body">
                    @item.message
                    @if (item.filename != null)
                    {<p style="margin-top: 10px">
                            @{
                                List<string> files = item.filename.Split(" ").ToList();
                            }
                            @if (files.Count > 1)
                            {
                                <span>
                                    Files: @foreach (var item2 in files)
                                    {
                                        <span> <a href="/files/@item2.Trim().Split('/').Last()" download>@item2.Trim().Split('/').Last()</a></span>

                                    }
                                </span>
                            }
                            else
                            {
                                <span>File:  <span> <a href="/files/@item.filename" download>@item.filename.Split('/').Last()</a></span> </span>
                            }
                        </p>}
                </div>
            </div>
        </div>row++;
    }

    <div class="card">
        <div class="card-header" id="headingOne">
            <h2 class="mb-0">
                <button class="btn btn-link" id="btnMail" type="button" data-toggle="collapse" data-target="#collapse" aria-expanded="true" aria-controls="collapseOne">
                    <p style="text-align: start">Subject: @ViewBag.ticket.subject</p>     <p style="text-align: start">Date: @ViewBag.ticket.datetime.ToString("dd MMMM yyyy hh:mm") </p>  <p style="text-align: start">
                        From whom: @if (ViewBag.ticket.clientID == HttpContextAccessor.HttpContext.Session.GetInt32("LogedIn").GetValueOrDefault(0))
                        {<span>you</span> }
                        else
                        { <span>@ViewBag.ClientName</span>}
                    </p>
                </button>
            </h2>
        </div>

        <div id="collapse" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
            <div class="card-body">
                @ViewBag.ticket.message
                @if (ViewBag.ticket.filename != null)
                {<p style="margin-top: 10px">
                        @{
                            string[] files = ViewBag.ticket.filename.Split(" ");
                        }
                        @if (files.Length > 1)
                        {
                            <span>
                                Files: @foreach (var item in files)
                                {
                                    <span> <a href="/files/@item.Split('/').Last()" download>@item.Split('/').Last()</a></span>

                                }
                            </span>
                        }
                    </p>}
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div id="finished">
                <div class="d-flex justify-content-center vertical-center-text ">
                    <h3>Successfully Sent <i style="color: green;" class="far fa-check-circle"></i></h3>
                </div>
            </div>
            <div class="modal-header model-header-success">
                <h5 class="modal-title" id="exampleModalLongTitle">Send Message</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addAction" action="@Url.Action("AddMessage","Home")" method="post" enctype="multipart/form-data">

                <div class="modal-body">

                    <label for="subject" style="font-size: 20px;">Subject:</label><br>
                    <input name="subject" class="form-control" type="text" /> <br />
                    <label for="text" style="font-size: 20px;">Message:</label> <br />
                    <textarea name="text" class="form-control" style="height: 250px;"></textarea> <br />
                    <label for="files" style="font-size: 20px;">File:</label> <br />
                    <input type="file" id="file" accept=".pdf, .doc, .jpeg, .png, .jpg" class="form-control-file" name="files" multiple />
                    <input type="hidden" value="@ViewBag.ticket.id" name="ticketid"/>

                </div>
                <div class="modal-footer">
                    <button type="submit" id="submiting" class="btn btn-primary">Send</button>
                </div>
                <div id="loading" class="loadingModel">
                    <div class="d-flex justify-content-center vertical-center ">
                        <div class="spinner-grow" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
        var uploadField = document.getElementById("file");

        uploadField.onchange = function() {
                if(this.files[0].size > 2048000){
                    alert("File size must be less than 2MB!");
                    this.value = "";
                    };
                };

    $(".loadingModel").hide();
    $("#finished").hide();
    $("#submiting").click(() => $(".loadingModel").show())
    $('#addAction').ajaxForm(function () {
        $(".loadingModel").hide();
        $(".model-header-success").hide();
        $("#addAction").hide()
        $("#finished").show()
        window.location.reload()
    });

    function myFunction() {

        var r = confirm("Are you sure to close the ticket?");

        if (r == true) {
            $.get("/home/closeticket/@ViewBag.ticket.id", function () {
                location.reload()
            })
            }
            else {

            }
                  
}
</script>